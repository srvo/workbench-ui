<!DOCTYPE html>
<html>
<head>
    <title>Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
        .pending { background: #fff3cd; }
    </style>
</head>
<body>
    <h1>Frontend-Backend Integration Test</h1>
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');
        let tests = [];

        function addTest(name, status, details = '') {
            tests.push({name, status, details});
            updateResults();
        }

        function updateResults() {
            results.innerHTML = tests.map(test =>
                `<div class="test ${test.status}">
                    <strong>${test.name}</strong>: ${test.status.toUpperCase()}
                    ${test.details ? `<br><small>${test.details}</small>` : ''}
                </div>`
            ).join('');
        }

        async function runTests() {
            addTest('Starting tests', 'pending');

            // Test 1: API Health
            try {
                const response = await fetch('https://workbenchapi.ethicic.com/api/securities/tick/investable');
                const data = await response.json();
                if (data.length > 0 && data[0].symbol) {
                    addTest('API Health Check', 'pass', `Got ${data.length} securities`);
                } else {
                    addTest('API Health Check', 'fail', 'No securities returned');
                }
            } catch (e) {
                addTest('API Health Check', 'fail', e.message);
            }

            // Test 2: Default Securities Load (simulating frontend)
            try {
                const response = await fetch('https://workbenchapi.ethicic.com/api/securities/tick/investable');
                const ticks = await response.json();

                // Transform like frontend does
                const securities = ticks.map(tick => ({
                    symbol: tick.symbol,
                    name: tick.name,
                    sector: tick.sector,
                    industry: tick.sector,
                    is_excluded: false,
                    last_tick_at: tick.updated_at?.split('T')[0]
                }));

                if (securities.length > 0 && securities.find(s => s.symbol === 'AGM')) {
                    addTest('Default Securities Load', 'pass', `Found AGM in ${securities.length} securities`);
                } else {
                    addTest('Default Securities Load', 'fail', `AGM not found in ${securities.length} securities`);
                }
            } catch (e) {
                addTest('Default Securities Load', 'fail', e.message);
            }

            // Test 3: Search Functionality
            try {
                const response = await fetch('https://workbenchapi.ethicic.com/api/securities/?search=agm');
                const data = await response.json();

                if (data.length > 0 && data[0].symbol === 'AGM') {
                    addTest('Search AGM', 'pass', `AGM is first result out of ${data.length}`);
                } else {
                    addTest('Search AGM', 'fail', `Expected AGM first, got: ${data[0]?.symbol || 'no results'}`);
                }
            } catch (e) {
                addTest('Search AGM', 'fail', e.message);
            }

            // Test 4: Frontend Container Response
            try {
                const response = await fetch('http://localhost:4173/health');
                const health = await response.text();
                if (health === 'healthy') {
                    addTest('Frontend Container', 'pass', 'Container healthy');
                } else {
                    addTest('Frontend Container', 'fail', `Got: ${health}`);
                }
            } catch (e) {
                addTest('Frontend Container', 'fail', 'Cannot reach frontend container');
            }

            // Test 5: CORS and Direct API Call from Browser
            try {
                const response = await fetch('https://workbenchapi.ethicic.com/api/securities/?search=apple');
                const data = await response.json();

                if (data.length > 0 && data[0].symbol === 'AAPL') {
                    addTest('CORS and Apple Search', 'pass', `AAPL first in ${data.length} results`);
                } else {
                    addTest('CORS and Apple Search', 'fail', `Expected AAPL, got ${data[0]?.symbol}`);
                }
            } catch (e) {
                addTest('CORS and Apple Search', 'fail', e.message);
            }

            addTest('All tests completed', 'pending');
        }

        runTests();
    </script>
</body>
</html>